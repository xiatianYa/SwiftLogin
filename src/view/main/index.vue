<template>
    <div class="mainPage p-20">
        <div class="main-left mr-10">
            <n-card class="echarts mb-10">
                <personnelEcharts :chartData="personnelData"></personnelEcharts>
            </n-card>
            <n-card class="timeline mb-10">
                <n-space>
                    <span style="font-size: 16px;font-weight: bold;">
                        È°πÁõÆÂä®ÊÄÅ
                    </span>
                </n-space>
                <n-timeline class="mt-10">
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÂú∞ÂõæËÆ¢ÈòÖ Êñ∞Â¢û‰∫ÆÂ∫¶Ê®°ÂºèÂàáÊç¢ v0.0.1" time="2024-08-11" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÂÖ®Â±ÄËÆæÁΩÆ ‰øÆÊîπÈÖçÁΩÆÈ°πÊêúÁ¥¢ÊúçÂä°Âô® v0.0.2" time="2024-08-12" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÁªëÈîÆÂä©Êâã v0.0.3" time="2024-08-12" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÂú∞ÂõæÂàóË°® v0.0.4" time="2024-08-24" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÂú∞ÂõæËÆ¢ÈòÖÈÄöÁü• v0.0.4" time="2024-08-29" />
                    <n-timeline-item type="success" content="‰ºòÂåñ‰ª£Á†Å,Êñ∞Â¢ûÊå§Êúç/ÊåÇÊú∫Êï∞ÊçÆÂõæÁâáÊòæÁ§∫,Êñ∞Â¢ûÂú∞ÂõæËÆ¢ÈòÖÂõæÁâáÊòæÁ§∫ v0.0.5" time="2024-08-29" />
                    <n-timeline-item type="success" content="‰ºòÂåñ‰ª£Á†Å,‰ºòÂåñÊúçÂä°Âô®Êü•ËØ¢ÊïàÁéá,‰ºòÂåñÊå§ÊúçÊú∫Âà∂ v0.0.6" time="2024-09-01" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÁî®Êà∑ÁôªÂΩï,Êñ∞Â¢ûËÅäÂ§©ÂÆ§ v0.0.7" time="2024-09-04" />
                    <n-timeline-item type="success" content="Âà†Èô§ÊåÇÊú∫Ê®°Âºè(Èò≤Ê≠¢ÊÅ∂ÊÑèÊåÇÊú∫) v0.0.8" time="2024-09-05" />
                    <n-timeline-item type="success" content="‰ºòÂåñÂú∞ÂõæËÆ¢ÈòÖ,ÂÆûÁé∞Â§öÂõæ,Á§æÂå∫ÂãæÈÄâ,‰ºòÂåñËÅäÂ§©ÂÆ§ÂäüËÉΩ v0.0.9" time="2024-09-06" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÈ¶ñÈ°µÊ®°Âùó,Êï∞ÊçÆÂèØËßÜÂåñÂ±èÂπï v0.1.0" time="2024-09-07" />
                    <n-timeline-item type="success" content="‰øÆÊîπÂâçÂêå‰∫ãÁöÑÁãóÂ±é‰ª£Á†ÅÁªÑ‰ª∂,ÊàëÂ∞±‰∏çÂ∫îËØ•Áî®‰Ω†ÁöÑÁªÑ‰ª∂,ÊàëÊµãÊµãÊµãÊ≠ª‰Ω†ÁöÑüêé v0.1.1"
                        time="2024-09-07" />
                    <n-timeline-item type="success" content="‰ºòÂåñÂú∞ÂõæËÆ¢ÈòÖ,ÂèØÂà†Èô§ËÆ¢ÈòÖÂú∞Âõæ,ÊµèËßàÂô®Âà∑Êñ∞Âêé‰πãÂâçËÆ¢ÈòÖÁöÑÂú∞Âõæ‰∏ç‰ºöÂà†Èô§ v0.1.2"
                        time="2024-09-10" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÁõ¥Êí≠Êé®Ëçê(Â§ß‰∏ªÊí≠ÂÖ•È©ªËØ∑Âä†ÂèçÈ¶àÁæ§),‰øÆÂ§çËá™Âä®Êå§ÊúçBug(ÁâπÊÄß) v0.1.3"
                        time="2024-09-12" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÂêÑÁ§æÂå∫ÂØºËà™,‰ºòÂåñÂú∞ÂõæÂàóË°®ÂäüËÉΩ v0.1.4" time="2024-09-14" />
                    <n-timeline-item type="success" content="Êñ∞Â¢ûÁïôË®ÄÁâà" time="2024-09-19" />
                    <n-timeline-item content="Êñ∞Â¢ûÁôªÂΩïÂô®ËΩØ‰ª∂,Êó†ÈúÄÊµèËßàÂô®ÁâàÊú¨" time="ÂæÖÂÆö" line-type="dashed" />
                </n-timeline>
            </n-card>
        </div>
        <div class="main-right ml-10">
            <n-card class="echarts mb-10">
                <personnelCake :chartData="personnelCakeData"></personnelCake>
            </n-card>
            <n-card class="echarts mb-10">
                <n-space>
                    <span style="font-size: 16px;font-weight: bold;">
                        Âú®Á∫øÁî®Êà∑
                    </span>
                </n-space>
                <n-space>
                    <n-tooltip placement="top-start" trigger="hover" v-for="user in globalStore.onlineUserList">
                        <template #trigger>
                            <n-avatar class="mr-5 mt-5" round size="medium" :src="user.src" />
                        </template>
                        {{ user.name }}
                    </n-tooltip>
                </n-space>
            </n-card>
            <n-card class="echarts mb-10">
                <n-space>
                    <span style="font-size: 16px;font-weight: bold;">
                        ËµûËµèÁ†Å
                    </span>
                </n-space>
                <n-space>
                    <n-image width="100%" height="200"
                        src="https://bluearchive.top/statics/2024/09/13/zanshangma.png" />
                </n-space>
            </n-card>
        </div>
    </div>
</template>

<script setup lang="ts">
import personnelEcharts from "@/components/baseUI/personnelEcharts/index.vue";
import personnelCake from "@/components/baseUI/personnelCake/index.vue";
import useStore from "@/store";
import { ref, onMounted, onUnmounted, watch } from 'vue';
import { statisticsEchats } from '@/api/statistics';
import { NTimeline, NTimelineItem, NCard, NSpace, NImage, NAvatar, NTooltip } from 'naive-ui';
import { getUserList } from "@/api/chat";
let { globalStore } = useStore();

//Âú®Á∫ø‰∫∫Êï∞ÈÖçÁΩÆ
const personnelData = ref([])

//È•ºÂõæÈÖçÁΩÆ
const personnelCakeData = ref<any>([])

//Âú®Á∫ø‰∫∫Êï∞ÂÆöÊó∂‰ªªÂä°
const personnelTimer = ref()

const init = async () => {
    //Ëé∑ÂèñÂú®Á∫ø‰∫∫Êï∞Êï∞ÊçÆ
    let statisticsResult: any = await statisticsEchats();
    personnelData.value = statisticsResult.data;
    //Ëé∑ÂèñÂú®Á∫øÁî®Êà∑Êï∞ÊçÆ
    getUserList().then((res) => {
        globalStore.onlineUserList = res.data.map((item: any) => {
            let { userId, userAvatar, userNickName } = item;
            return {
                id: userId,
                name: userNickName,
                src: userAvatar,
            };
        });
    });
    personnelTimer.value = setInterval(async () => {
        //Ëé∑ÂèñÂú®Á∫ø‰∫∫Êï∞Êï∞ÊçÆ
        let statisticsResult: any = await statisticsEchats();
        personnelData.value = statisticsResult.data;
        //Ëé∑ÂèñÂú®Á∫øÁî®Êà∑Êï∞ÊçÆ
        getUserList().then((res) => {
            globalStore.onlineUserList = res.data.map((item: any) => {
                let { userId, userAvatar, userNickName } = item;
                return {
                    id: userId,
                    name: userNickName,
                    src: userAvatar,
                };
            });
        });
    }, 10000)
}

watch(() => globalStore.serverInfo, async (newValue: any, oldValue: any) => {
    if (!newValue) {
        return;
    }
    personnelCakeData.value = [];
    globalStore.serverInfo.forEach((value: any, key: any) => {
        let countPersonnel = 0;
        let responsePromise = JSON.parse(value)
        responsePromise.map((item: any) => {
            //Ëé∑ÂèñÊúçÂä°Âô®‰ø°ÊÅØ
            let serverInfo = item.response.servers
            if (!serverInfo) return;
            //Ëé∑ÂèñÂú®Á∫ø‰∫∫Êï∞
            let { players } = serverInfo[0]
            countPersonnel += players;
        })
        personnelCakeData.value.push(countPersonnel);
    })
}, { deep: true })
onUnmounted(() => {
    clearInterval(personnelTimer.value);
})
onMounted(() => {
    init();
})
</script>

<style scoped lang="scss">
.mainPage {
    display: flex;
    width: 100%;
    height: 100%;

    .main-left {
        width: 50%;

        .echarts {
            width: 100%;
            height: 50%;
            border-radius: 5px;
        }

        .timeline {
            width: 100%;
            border-radius: 5px;
        }
    }

    .main-right {
        width: 50%;

        .echarts {
            width: 100%;
            height: 50%;
            border-radius: 5px;
        }
    }
}
</style>