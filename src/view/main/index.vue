<template>
    <div class="mainPage p-20">
        <div class="main-left mr-10">
            <n-card class="echarts mb-10">
                <personnelEcharts :chartData="personnelData"></personnelEcharts>
            </n-card>
            <n-card class="timeline mb-10">
                <n-space class="mb-10">
                    <span style="font-size: 16px;font-weight: bold;">
                        é¡¹ç›®åŠ¨æ€
                    </span>
                </n-space>
                <n-timeline class="mb-10">
                    <n-timeline-item type="success" content="æ–°å¢åœ°å›¾è®¢é˜… æ–°å¢äº®åº¦æ¨¡å¼åˆ‡æ¢ v0.0.1" time="2024-08-11" />
                    <n-timeline-item type="success" content="æ–°å¢å…¨å±€è®¾ç½® ä¿®æ”¹é…ç½®é¡¹æœç´¢æœåŠ¡å™¨ v0.0.2" time="2024-08-12" />
                    <n-timeline-item type="success" content="æ–°å¢ç»‘é”®åŠ©æ‰‹ v0.0.3" time="2024-08-12" />
                    <n-timeline-item type="success" content="æ–°å¢åœ°å›¾åˆ—è¡¨ v0.0.4" time="2024-08-24" />
                    <n-timeline-item type="success" content="æ–°å¢åœ°å›¾è®¢é˜…é€šçŸ¥ v0.0.4" time="2024-08-29" />
                    <n-timeline-item type="success" content="ä¼˜åŒ–ä»£ç ,æ–°å¢æŒ¤æœ/æŒ‚æœºæ•°æ®å›¾ç‰‡æ˜¾ç¤º,æ–°å¢åœ°å›¾è®¢é˜…å›¾ç‰‡æ˜¾ç¤º v0.0.5" time="2024-08-29" />
                    <n-timeline-item type="success" content="ä¼˜åŒ–ä»£ç ,ä¼˜åŒ–æœåŠ¡å™¨æŸ¥è¯¢æ•ˆç‡,ä¼˜åŒ–æŒ¤æœæœºåˆ¶ v0.0.6" time="2024-09-01" />
                    <n-timeline-item type="success" content="æ–°å¢ç”¨æˆ·ç™»å½•,æ–°å¢èŠå¤©å®¤ v0.0.7" time="2024-09-04" />
                    <n-timeline-item type="success" content="åˆ é™¤æŒ‚æœºæ¨¡å¼(é˜²æ­¢æ¶æ„æŒ‚æœº) v0.0.8" time="2024-09-05" />
                    <n-timeline-item type="success" content="ä¼˜åŒ–åœ°å›¾è®¢é˜…,å®ç°å¤šå›¾,ç¤¾åŒºå‹¾é€‰,ä¼˜åŒ–èŠå¤©å®¤åŠŸèƒ½ v0.0.9" time="2024-09-06" />
                    <n-timeline-item type="success" content="æ–°å¢é¦–é¡µæ¨¡å—,æ•°æ®å¯è§†åŒ–å±å¹• v0.1.0" time="2024-09-07" />
                    <n-timeline-item type="success" content="ä¿®æ”¹å‰åŒäº‹çš„ç‹—å±ä»£ç ç»„ä»¶,æˆ‘å°±ä¸åº”è¯¥ç”¨ä½ çš„ç»„ä»¶,æˆ‘æµ‹æµ‹æµ‹æ­»ä½ çš„ğŸ v0.1.1"
                        time="2024-09-07" />
                    <n-timeline-item type="success" content="ä¼˜åŒ–åœ°å›¾è®¢é˜…,å¯åˆ é™¤è®¢é˜…åœ°å›¾,æµè§ˆå™¨åˆ·æ–°åä¹‹å‰è®¢é˜…çš„åœ°å›¾ä¸ä¼šåˆ é™¤ v0.1.2"
                        time="2024-09-10" />
                    <n-timeline-item type="success" content="æ–°å¢ç›´æ’­æ¨è(å¤§ä¸»æ’­å…¥é©»è¯·åŠ åé¦ˆç¾¤),ä¿®å¤è‡ªåŠ¨æŒ¤æœBug(ç‰¹æ€§) v0.1.3"
                        time="2024-09-12" />
                    <n-timeline-item type="success" content="æ–°å¢å„ç¤¾åŒºå¯¼èˆª,ä¼˜åŒ–åœ°å›¾åˆ—è¡¨åŠŸèƒ½ v0.1.4" time="2024-09-14" />
                    <n-timeline-item type="success" content="æ–°å¢ç•™è¨€ç‰ˆ v0.1.5" time="2024-09-19" />
                    <n-timeline-item type="success" content="æ–°å¢ç™»å½•å™¨è½¯ä»¶,æ— éœ€æµè§ˆå™¨ç‰ˆæœ¬ v0.1.6" time="2024-09-22" />
                    <n-timeline-item content="æ–°å¢å„ç¤¾åŒºåœ°å›¾CDæ˜¾ç¤º(éœ€ç¤¾åŒºæä¾›APIæ¥å£)" time="å¾…å®š" line-type="dashed" />
                    <n-timeline-item content="é€‚é…ç§»åŠ¨ç«¯UIé¡µé¢" time="å¾…å®š" line-type="dashed" />
                </n-timeline>
            </n-card>
        </div>
        <div class="main-right mr-10">
            <n-card class="echarts mb-10">
                <personnelCake :chartData="personnelCakeData"></personnelCake>
            </n-card>
            <n-card class="mb-10">
                <n-space>
                    <span style="font-size: 16px;font-weight: bold;">
                        åœ¨çº¿ç”¨æˆ·
                    </span>
                </n-space>
                <n-space>
                    <n-tooltip placement="top-start" trigger="hover" v-for="user, index in globalStore.onlineUserList"
                        :key="index">
                        <template #trigger>
                            <n-avatar class="mr-5 mt-5" round size="medium" :src="user.src" />
                        </template>
                        {{ user.name }}
                    </n-tooltip>
                </n-space>
            </n-card>
            <n-card class="sponsor mb-10">
                <n-space>
                    <span style="font-size: 16px;font-weight: bold;">
                        èµèµç 
                    </span>
                </n-space>
                <n-space>
                    <n-image width="100%" height="200"
                        src="https://bluearchive.top/statics/2024/09/13/zanshangma.png" />
                </n-space>
                <n-space>
                    <span style="font-size: 16px;font-weight: bold;">
                        èµèµè®°å½•
                    </span>
                </n-space>
                <n-table :bordered="true" :single-line="false">
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>èµèµé‡‘é¢</th>
                            <th>èµèµæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æ— é‚¬</td>
                            <td>3å…ƒ</td>
                            <td>2024-09-14</td>
                        </tr>
                        <tr>
                            <td>Cmz</td>
                            <td>5å…ƒ</td>
                            <td>2024-09-23</td>
                        </tr>
                        <tr>
                            <td>é˜¿é£</td>
                            <td>5å…ƒ</td>
                            <td>2024-09-24</td>
                        </tr>
                        <tr>
                            <td>kk</td>
                            <td>10å…ƒ</td>
                            <td>2024-09-25</td>
                        </tr>
                        <tr>
                            <td>çº¢è±†</td>
                            <td>5å…ƒ</td>
                            <td>2024-09-28</td>
                        </tr>
                        <tr>
                            <td>Rainsfieldâ˜¨</td>
                            <td>50å…ƒ</td>
                            <td>2024-10-1</td>
                        </tr>
                        <tr>
                            <td>æ°”è½©è¾•</td>
                            <td>8.8.8å…ƒ</td>
                            <td>2024-10-1</td>
                        </tr>
                        <tr>
                            <td>Noxx_</td>
                            <td>10å…ƒ</td>
                            <td>2024-10-2</td>
                        </tr>
                        <tr>
                            <td>ä¸å…³æ°æ°çš„äº‹</td>
                            <td>60å…ƒ</td>
                            <td>2024-10-3</td>
                        </tr>
                    </tbody>
                </n-table>
                <n-space class="mt-5">ä½œè€…åœ¨è¿™é‡Œéå¸¸æ„Ÿè°¢ä»¥ä¸ŠèµåŠ©å¯¹è¯¥ç™»å½•å™¨çš„æ”¯æŒ,éå¸¸æ„Ÿè°¢ã€‚</n-space>
            </n-card>
        </div>
    </div>
</template>

<script setup lang="ts">
import personnelEcharts from "@/components/baseUI/personnelEcharts/index.vue";
import personnelCake from "@/components/baseUI/personnelCake/index.vue";
import useStore from "@/store";
import { ref, onMounted, onUnmounted, watch } from 'vue';
import { statisticsEchats } from '@/api/statistics';
import { NTimeline, NTimelineItem, NCard, NSpace, NImage, NAvatar, NTooltip, NTable } from 'naive-ui';
import { getUserList } from "@/api/chat";
let { globalStore } = useStore();

//åœ¨çº¿äººæ•°é…ç½®
const personnelData = ref([])

//é¥¼å›¾é…ç½®
const personnelCakeData = ref<any>([])

//åœ¨çº¿äººæ•°å®šæ—¶ä»»åŠ¡
const personnelTimer = ref()

const init = async () => {
    //è·å–åœ¨çº¿äººæ•°æ•°æ®
    let statisticsResult: any = await statisticsEchats();
    personnelData.value = statisticsResult.data;
    //è·å–åœ¨çº¿ç”¨æˆ·æ•°æ®
    getUserList().then((res) => {
        globalStore.onlineUserList = res.data.map((item: any) => {
            let { userId, userAvatar, userNickName } = item;
            return {
                id: userId,
                name: userNickName,
                src: userAvatar,
            };
        });
    });
    personnelTimer.value = setInterval(async () => {
        //è·å–åœ¨çº¿äººæ•°æ•°æ®
        let statisticsResult: any = await statisticsEchats();
        personnelData.value = statisticsResult.data;
        //è·å–åœ¨çº¿ç”¨æˆ·æ•°æ®
        getUserList().then((res) => {
            globalStore.onlineUserList = res.data.map((item: any) => {
                let { userId, userAvatar, userNickName } = item;
                return {
                    id: userId,
                    name: userNickName,
                    src: userAvatar,
                };
            });
        });
    }, 10000)
}

watch(() => globalStore.serverInfo, async (newValue: any, oldValue: any) => {
    if (!newValue) {
        return;
    }
    personnelCakeData.value = [];
    globalStore.serverInfo.forEach((value: any, key: any) => {
        let countPersonnel = 0;
        let responsePromise = JSON.parse(value)
        responsePromise.map((item: any) => {
            //è·å–æœåŠ¡å™¨ä¿¡æ¯
            let serverInfo = item.response.servers
            if (!serverInfo) return;
            //è·å–åœ¨çº¿äººæ•°
            let { players } = serverInfo[0]
            countPersonnel += players;
        })
        personnelCakeData.value.push(countPersonnel);
    })
}, { deep: true })
onUnmounted(() => {
    clearInterval(personnelTimer.value);
    personnelTimer.value = null;
})
onMounted(() => {
    init();
})
</script>

<style scoped lang="scss">
.mainPage {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    width: 100%;
    height: auto;

    .main-left {
        width: 48%;
        height: 100%;
        min-width: 250px;

        .echarts {
            width: 100%;
            height: 400px;
            border-radius: 5px;
        }

        .timeline {
            width: 100%;
            border-radius: 5px;
        }
    }

    .main-right {
        width: 48%;
        height: 100%;
        min-width: 250px;

        .echarts {
            width: 100%;
            height: 400px;
            border-radius: 5px;
        }

        .sponsor {
            width: 100%;
            min-height: 250px;
        }
    }
}

@media (max-width: 600px) {
    .mainPage {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        width: 100%;
        height: auto;

        .main-left {
            width: 100%;
            height: 100%;

            .echarts {
                width: 100%;
                height: 400px;
                border-radius: 5px;
            }

            .timeline {
                width: 100%;
                border-radius: 5px;
            }
        }

        .main-right {
            width: 100%;
            height: 100%;

            .echarts {
                width: 100%;
                height: 400px;
                border-radius: 5px;
            }

            .sponsor {
                width: 100%;
                min-height: 250px;
            }
        }
    }
}
</style>